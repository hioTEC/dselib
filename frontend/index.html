<!DOCTYPE html>
<html lang="zh-HK">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE Lib - Past Paper</title>
    <link rel="icon" href="https://dselib.com/book.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="DSE Lib">
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="icon" type="image/x-icon" href="https://dselib.com/favicon.ico">
    <style>
        /* 复刻 dselib 的一些关键配色和圆角风格 */
        :root {
            --primary-color: #3b82f6;
            /* 类似原站的高亮蓝 */
            --bg-color: #f8f9fa;
        }

        :root.dark {
            --bg-color: #000000;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            transition: background-color 0.3s ease;
        }

        .subject-card {
            transition: all 0.2s;
            cursor: pointer;
        }

        .subject-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .icon-box {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* 简单的面包屑导航样式 */
        .breadcrumb span:not(:last-child)::after {
            content: "/";
            margin: 0 8px;
            color: #9ca3af;
        }

        .material-symbols-rounded {
            font-family: 'Material Symbols Rounded';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            display: inline-block;
            line-height: 1;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            -moz-osx-font-smoothing: grayscale;
            font-size: 20px;
            /* Default size match */
        }

        /* Custom scrollbar for sidebar */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #e5e7eb;
            border-radius: 20px;
        }

        /* Dark mode improvements for better readability */
        .dark .text-gray-400 {
            color: #9ca3af !important;
        }
        
        .dark .text-gray-500 {
            color: #9ca3af !important;
        }
        
        .dark .text-gray-700 {
            color: #e5e7eb !important;
        }
        
        .dark .border-gray-100 {
            border-color: #374151 !important;
        }
        
        .dark .border-gray-800 {
            border-color: #374151 !important;
        }
        
        .dark .bg-gray-50 {
            background-color: #1f2937 !important;
        }
        
        .dark .bg-gray-100 {
            background-color: #374151 !important;
        }
        
        .dark .hover\:bg-gray-50:hover {
            background-color: #374151 !important;
        }
        
        .dark .hover\:bg-gray-100:hover {
            background-color: #4b5563 !important;
        }
    </style>
</head>

<body
    class="bg-white dark:bg-black text-gray-800 dark:text-gray-100 font-sans antialiased selection:bg-black selection:text-white transition-colors duration-300">
    <div id="app" class="flex min-h-screen">

        <!-- Sidebar -->
        <aside
            class="w-64 fixed inset-y-0 left-0 bg-white dark:bg-black border-r border-gray-100 dark:border-gray-800 overflow-y-auto z-50 scrollbar-thin transition-transform duration-300"
            :class="mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'">
            <div class="p-6">

                <!-- Logo area (Icon or Text) -->
                <div class="flex justify-between items-center mb-8">
                    <div class="font-bold text-2xl tracking-tighter cursor-pointer" @click="goHome">
                        <span class="border-b-2 border-black">DSE</span> Lib
                    </div>
                    <!-- Close button for mobile -->
                    <button class="md:hidden text-gray-400 dark:text-gray-500 hover:text-black dark:hover:text-white"
                        @click="mobileMenuOpen = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="space-y-8">
                    <!-- Iterate through predefined category order -->
                    <template v-for="catKey in categoryOrder" :key="catKey">
                        <div v-if="groupedSubjects[catKey] && groupedSubjects[catKey].length > 0">
                            <h3 class="text-xs font-medium text-gray-400 dark:text-gray-500 uppercase tracking-widest mb-3">
                                {{ mapCategoryName(catKey) }}
                            </h3>
                            <ul class="space-y-1">
                                <li v-for="sub in groupedSubjects[catKey]" :key="sub.key">
                                    <div @click="selectSubject(sub)"
                                        class="flex items-center gap-3 px-2 py-2 rounded-lg cursor-pointer transition-colors duration-200 group"
                                        :class="currentSubject && currentSubject.key === sub.key ? 'bg-gray-100 dark:bg-gray-900 text-black dark:text-white font-semibold' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-900 hover:text-black dark:hover:text-white'">
                                        <!-- Use a smaller, simpler icon or just text if preferred. Image shows icons. -->
                                        <span class="material-symbols-rounded w-6 flex justify-center items-center transition-colors"
                                            :class="currentSubject && currentSubject.key === sub.key ? 'text-black dark:text-white' : 'text-gray-400 dark:text-gray-500 group-hover:text-black dark:group-hover:text-white'">
                                            {{ getMeta(sub.name).icon }}
                                        </span>
                                        <span class="text-sm">{{ getMeta(sub.name).zh }}</span>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </template>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <!-- Add left margin for sidebar offset -->
        <main class="flex-1 md:ml-64 p-8 md:p-12 lg:p-16 relative">

            <!-- Mobile Toggle -->
            <button class="md:hidden absolute top-4 left-4 p-2 text-gray-600 hover:text-black"
                @click="mobileMenuOpen = !mobileMenuOpen">
                <i class="fas fa-bars text-xl"></i>
            </button>

            <!-- Theme Toggle (Top Right) -->
            <div class="absolute top-8 right-8 flex items-center gap-4">
                <button @click="toggleDarkMode"
                    class="text-gray-400 dark:text-gray-500 hover:text-black dark:hover:text-white flex items-center transition">
                    <span class="material-symbols-rounded text-lg">{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</span>
                </button>
            </div>

            <!-- Content Area -->
            <div class="max-w-3xl mx-auto mt-8">

                <!-- Loading / Error -->
                <div v-if="loading" class="text-center py-20">
                    <span
                        class="material-symbols-rounded animate-spin text-4xl text-gray-300 dark:text-gray-600">progress_activity</span>
                </div>
                <div v-if="error" class="bg-red-50 text-red-600 p-4 rounded-lg mb-8 text-sm">
                    {{ error }}
                </div>

                <!-- HOME VIEW -->
                <div v-if="!currentSubject && !loading">
                    <header class="mb-12">
                        <h1 class="text-3xl font-bold mb-4 tracking-tight">{{ uiText.title }}</h1>
                        <p class="text-gray-400 dark:text-gray-500 text-sm">{{ uiText.disclaimer }}</p>
                    </header>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Use displayList computed property for custom sorting -->
                        <div v-for="sub in displayList" :key="sub.key" @click="selectSubject(sub)"
                            class="group border border-gray-100 dark:border-gray-800 rounded-xl p-6 hover:border-gray-300 dark:hover:border-gray-700 transition-all cursor-pointer bg-white dark:bg-gray-900 hover:shadow-sm">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <span class="material-symbols-rounded text-2xl text-gray-800 dark:text-gray-200">{{
                                        getMeta(sub.name).icon }}</span>
                                    <div>
                                        <h3 class="font-bold text-lg">{{ getMeta(sub.name).en }}</h3>
                                        <p class="text-xs text-gray-400">{{ getMeta(sub.name).zh }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-400 dark:text-gray-500 font-mono">
                                {{ getYearRange(sub) }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SUBJECT VIEW -->
                <div v-if="currentSubject">
                    <!-- Breadcrumb -->
                    <div class="text-xs text-gray-400 dark:text-gray-500 mb-6 flex items-center gap-2">
                        <span class="cursor-pointer hover:text-black dark:hover:text-white" @click="goHome">{{
                            uiText.all }}</span>
                        <span class="material-symbols-rounded text-[16px] flex items-center">chevron_right</span>
                        <span>{{ getMeta(currentSubject.name).displayKey || getMeta(currentSubject.name).en }}</span>
                    </div>

                    <!-- Header -->
                    <header class="mb-16">
                        <div class="flex justify-between items-start mb-4">
                            <h1 class="text-4xl font-extrabold tracking-tight">{{ language === 'en' ?
                                getMeta(currentSubject.name).en : getMeta(currentSubject.name).zh }}
                            </h1>
                        </div>
                        <p class="text-gray-400 dark:text-gray-400 text-sm font-mono mb-6">{{
                            getYearRange(currentSubject) }}</p>

                        <!-- Dynamic Exam Type Buttons -->
                        <!-- Combined Controls - Fixed height for consistency -->
                        <div class="flex items-center gap-4 min-h-[32px]">
                            <!-- Dynamic Exam Type Buttons -->
                            <div class="flex gap-2">
                                <template v-for="exam in getAvailableExams(currentSubject)" :key="exam">
                                    <button @click="switchExamType(exam)"
                                        :class="examType === exam ? 'bg-gray-100 dark:bg-gray-700 text-black dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-black dark:hover:text-white'"
                                        class="px-3 py-1 text-xs font-bold rounded transition">{{ exam.toUpperCase() }}</button>
                                </template>
                            </div>
                            
                            <!-- Language Toggle (only if multiple languages available) -->
                            <div v-if="getAvailableLanguages(currentSubject).length > 1" class="flex items-center bg-gray-100 dark:bg-gray-800 rounded-lg p-1 transition-colors">
                                <button @click="switchLanguage('zh')"
                                    :class="language === 'zh' ? 'bg-white dark:bg-gray-700 text-black dark:text-white shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white'"
                                    class="px-3 py-1 text-xs font-semibold rounded-md transition">中</button>
                                <button @click="switchLanguage('en')"
                                    :class="language === 'en' ? 'bg-white dark:bg-gray-700 text-black dark:text-white shadow-sm' : 'text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white'"
                                    class="px-3 py-1 text-xs font-medium rounded-md transition">EN</button>
                            </div>
                            
                            <!-- Placeholder to maintain height when no language toggle -->
                            <div v-else class="w-20 h-8"></div>
                        </div>
                    </header>

                    <!-- File List -->
                    <div class="space-y-2">
                        <div v-for="yearData in sortedYears" :key="yearData.year"
                            class="flex flex-col md:flex-row md:items-start gap-4 group w-full transition-colors rounded-lg p-2 border-b border-gray-50 dark:border-gray-800 last:border-0">
                            <!-- Year Column - Fixed width for consistency -->
                            <div class="w-24 md:w-32 font-mono font-bold text-sm md:text-base text-gray-800 dark:text-gray-200 shrink-0 whitespace-nowrap text-left flex items-center h-[29px]">
                                {{ formatYearLabel(yearData.year) }}
                            </div>

                            <!-- Files Column -->
                            <div class="flex-1 min-w-0">
                                <div class="flex flex-wrap gap-3 items-center">
                                    <a v-for="file in yearData.files" :key="file.path" :href="resolveFilePath(file.path)" target="_blank"
                                        class="px-3 py-1.5 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 text-xs font-medium rounded text-gray-700 dark:text-gray-300 transition-colors whitespace-nowrap max-w-[100px] overflow-hidden text-ellipsis">
                                        {{ getShortFileName(file.name) }}
                                    </a>
                                    
                                    <!-- Download Button (Merged) -->
                                    <button
                                        @click="downloadYear(yearData)"
                                        :disabled="downloadingYear === yearData.year"
                                        class="ml-auto py-1.5 px-3 bg-black dark:bg-gray-800 text-white text-xs font-bold rounded hover:bg-gray-800 dark:hover:bg-gray-700 transition flex items-center justify-center gap-1 disabled:opacity-50 min-w-[64px]">
                                        <span class="material-symbols-rounded text-sm">download</span>
                                        <span class="text-xs" v-if="downloadingYear === yearData.year">...</span>
                                        <span class="text-xs" v-else>下载</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue

        const SUBJECT_META = {
            'Chinese History': { zh: '中國歷史', en: 'Chinese History', displayKey: 'chi_hist', category: 'Arts', icon: 'temple_buddhist' },
            'Chinese': { zh: '中文', en: 'Chinese', displayKey: 'chi', category: 'Core', icon: 'history_edu' }, // User: 'scroll' -> history_edu
            'English': { zh: '英文', en: 'English', displayKey: 'eng', category: 'Core', icon: 'translate' }, // User: 'same as chi' -> translate/language? User said "English should use NOW Chinese icon (fa-language)". So English -> translate.
            'Mathematics M1': { zh: '微積分與統計 (M1)', en: 'Maths (M1)', displayKey: 'm1', category: 'Science', icon: 'pie_chart' },
            'Mathematics M2': { zh: '代數與微積分 (M2)', en: 'Maths (M2)', displayKey: 'm2', category: 'Science', icon: 'functions' },
            'Mathematics': { zh: '數學', en: 'Mathematics', displayKey: 'm0', category: 'Core', icon: 'calculate' },
            'Citizenship': { zh: '公民與社會發展', en: 'Citizenship', displayKey: 'cs', category: 'Core', icon: 'public' },
            'Liberal Studies': { zh: '通識教育', en: 'Liberal Studies', displayKey: 'ls', category: 'Arts', icon: 'newspaper' }, // User moved LS to Arts in list

            'Physics': { zh: '物理', en: 'Physics', displayKey: 'phy', category: 'Science', icon: 'electric_bolt' },
            'Chemistry': { zh: '化學', en: 'Chemistry', displayKey: 'chem', category: 'Science', icon: 'science' },
            'Biology': { zh: '生物', en: 'Biology', displayKey: 'bio', category: 'Science', icon: 'biotech' },
            'ICT': { zh: '資訊及通訊科技', en: 'ICT', displayKey: 'ict', category: 'Science', icon: 'computer' },

            'BAFS': { zh: '企業、會計與財務概論', en: 'BAFS', displayKey: 'bafs', category: 'Commerce', icon: 'business_center' },
            'Economics': { zh: '經濟', en: 'Economics', displayKey: 'econ', category: 'Commerce', icon: 'trending_up' },

            'History': { zh: '世界歷史', en: 'History', displayKey: 'hist', category: 'Arts', icon: 'public' },
            'Geography': { zh: '地理', en: 'Geography', displayKey: 'geog', category: 'Arts', icon: 'landscape' },
            'Tourism': { zh: '旅遊與款待', en: 'Tourism', displayKey: 'tourism', category: 'Arts', icon: 'flight_takeoff' }
        };

        const CATEGORY_MAP = {
            'Core': '必修',
            'Science': '理科',
            'Commerce': '商科',
            'Arts': '文科',
            'Technology': '科技',
            'Others': '其他'
        };

        // User defined strict order
        const ORDER_CONFIG = {
            'Core': ['Chinese', 'English', 'Mathematics', 'Citizenship'],
            'Science': ['Physics', 'Chemistry', 'Biology', 'Mathematics M1', 'Mathematics M2', 'ICT'],
            'Commerce': ['Economics', 'BAFS'],
            'Arts': ['History', 'Chinese History', 'Tourism', 'Geography', 'Liberal Studies']
        };

        const app = createApp({
            data() {
                return {
                    rawData: [],
                    currentSubject: null,
                    searchQuery: '',
                    loading: true,
                    error: null,
                    mobileMenuOpen: false,
                    categoryOrder: ['Core', 'Science', 'Commerce', 'Arts', 'Others'],
                    examType: 'dse', // 'dse', 'ce', 'al'
                    language: 'zh', // 'zh', 'en'
                    isDarkMode: false,
                    downloadingYear: null,
                    isSwitching: false // New: loading state for switching
                }
            },
            computed: {
                uiText() {
                    const texts = {
                        zh: {
                            title: '过往试卷',
                            disclaimer: '本網站為學習資源交流平台，只作為學習用途，而非商業用途。若上載之內容涉及版權，請即與我們聯絡。',
                            all: '全部'
                        },
                        en: {
                            title: 'Past Papers',
                            disclaimer: 'This website is a learning resource exchange platform for educational purposes only, not for commercial use. Please contact us immediately if uploaded content involves copyright issues.',
                            all: 'All'
                        }
                    };
                    return texts[this.language] || texts.zh;
                },
                groupedSubjects() {
                    const groups = {
                        'Core': [], 'Science': [], 'Commerce': [], 'Arts': [], 'Others': []
                    };

                    // Helper to check if name matches key loosely
                    const getKey = (name) => {
                        for (const k in SUBJECT_META) {
                            if (name === k || name.includes(k)) return k;
                        }
                        return 'Other';
                    }

                    // Populate with placeholders based on order config to ensure sort order?
                    // No, simpler: Put actual data into groups, then sort groups.

                    this.rawData.forEach(sub => {
                        const meta = this.getMeta(sub.name);
                        const cat = meta.category || 'Others';
                        if (!groups[cat]) groups[cat] = [];
                        groups[cat].push(sub);
                    });

                    // Sort items within groups based on ORDER_CONFIG
                    Object.keys(ORDER_CONFIG).forEach(cat => {
                        if (groups[cat]) {
                            const orderList = ORDER_CONFIG[cat];
                            groups[cat].sort((a, b) => {
                                const keyA = getKey(a.name);
                                const keyB = getKey(b.name);
                                const idxA = orderList.indexOf(keyA);
                                const idxB = orderList.indexOf(keyB);
                                // If not found in strict list, push to end
                                return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
                            });
                        }
                    });

                    // Remove empty groups but keep the structure for Vue to render
                    Object.keys(groups).forEach(k => {
                        if (groups[k].length === 0) {
                            // Don't delete empty groups, just keep them
                        }
                    });

                    return groups;
                },
                // Display list for Home Grid - Flattened but sorted by Category then Subject Order
                displayList() {
                    let list = [];
                    this.categoryOrder.forEach(cat => {
                        if (this.groupedSubjects[cat]) {
                            list = list.concat(this.groupedSubjects[cat]);
                        }
                    });
                    return list;
                },
                sortedYears() {
                    if (!this.currentSubject) return [];

                    const yearsMap = {};
                    const targetLang = this.language === 'zh' ? 'chi' : 'eng';

                    // Method 1: Use structured 'exams' data (Preferred)
                    if (this.currentSubject.exams) {
                        const examData = this.currentSubject.exams[this.examType];
                        if (examData && examData.years) {
                            Object.values(examData.years).forEach(yearData => {
                                const y = yearData.display;
                                let langData = null;

                                // Try target language first
                                if (yearData.languages && yearData.languages[targetLang]) {
                                    langData = yearData.languages[targetLang];
                                }
                                // Fallback: If target language not found, and there's only one language available (e.g. English Subject), use it.
                                else if (yearData.languages && Object.keys(yearData.languages).length > 0) {
                                    // Optional: Check if subject is effectively single-language? 
                                    // For now, if we can't find the target language, show what we have IF it's likely the user wants to see it.
                                    // For English Subject (only 'eng'), we show 'eng'.
                                    // For Chinese Subject (only 'chi'), we show 'chi'.
                                    // For Math (both), we might NOT want to show English when User asks for Chinese?
                                    // Actually, if I select Chinese language for UI, I expect Chinese Math paper. If missing, do I want English?
                                    // Usually yes, better than nothing.
                                    const availableLangs = Object.keys(yearData.languages);
                                    if (availableLangs.length === 1) {
                                        langData = yearData.languages[availableLangs[0]];
                                    }
                                }

                                if (langData && langData.files) {
                                    if (!yearsMap[y]) yearsMap[y] = [];
                                    langData.files.forEach(f => {
                                        yearsMap[y].push({ ...f, year: y });
                                    });
                                }
                            });
                        }
                    }
                    // Method 2: Fallback for flat 'files' array (Legacy support)
                    else if (this.currentSubject.files) {
                        this.currentSubject.files.forEach(f => {
                            const path = (f.path || '').toLowerCase();
                            // Filter Exam Type
                            if (!path.includes(`/${this.examType}/`)) return;

                            // Filter Language (heuristic based on path segments)
                            if (!path.includes(`/${targetLang}/`)) return;

                            const y = f.year || 'Unknown';
                            if (!yearsMap[y]) yearsMap[y] = [];
                            yearsMap[y].push(f);
                        });
                    }

                    // Sort Years: Numeric descending first, then SP/PP last
                    const sortedKeys = Object.keys(yearsMap).sort((a, b) => {
                        const isSpecial = (y) => {
                            const ly = y.toString().toLowerCase();
                            return ly.includes('sp') || ly.includes('pp') || ly.includes('sample') || ly.includes('practice');
                        };
                        const aSpecial = isSpecial(a);
                        const bSpecial = isSpecial(b);
                        
                        if (aSpecial && !bSpecial) return 1;
                        if (!aSpecial && bSpecial) return -1;
                        // If both special, sort internal logic or keep consistent
                        if (aSpecial && bSpecial) return b.localeCompare(a); 
                        
                        return b.localeCompare(a);
                    });

                    return sortedKeys.map(y => {
                        return {
                            year: y,
                            files: yearsMap[y].sort((a, b) => {
                                const wA = this.fileWeight(a);
                                const wB = this.fileWeight(b);
                                if (wA !== wB) return wA - wB;
                                return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
                            })
                        };
                    });
                }
            },
            methods: {
                async loadData() {
                    this.loading = true;
                    this.error = null;

                    const protocol = window.location.protocol;
                    const href = window.location.href;

                    if (protocol === 'file:') {
                        this.error =
                            "本页面以文件方式打开（file://），浏览器会拦截数据读取。请用本地 HTTP 服务访问：\n" +
                            "  python -m http.server -d frontend 8000\n" +
                            "然后打开：http://localhost:8000/";
                        this.loading = false;
                        return;
                    }

                    // 固定唯一入口，避免"猜路径"导致偶发失败。
                    // 在 python -m http.server -d frontend 8000 下，对应 http://localhost:8000/public/data/index.json
                    const url = './public/data/index.json';

                    try {
                        const res = await fetch(url, { cache: 'no-store' });
                        if (!res.ok) {
                            this.error =
                                `Failed to load index.json (HTTP ${res.status}).\n` +
                                `url=${url}\n` +
                                `href=${href}\n`;
                            this.loading = false;
                            return;
                        }

                        const data = await res.json();
                        if (!data || !Array.isArray(data.subjects)) {
                            this.error =
                                `index.json schema mismatch: expected { subjects: [] }.\n` +
                                `url=${url}\n` +
                                `href=${href}\n`;
                            console.error('index.json payload:', data);
                            this.loading = false;
                            return;
                        }

                        this.rawData = data.subjects;
                        this.loading = false;
                    } catch (e) {
                        this.error =
                            `Failed to fetch index.json.\n` +
                            `url=${url}\n` +
                            `href=${href}\n` +
                            `error=${e?.message || e}`;
                        console.error(e);
                        this.loading = false;
                    }
                },
                selectSubject(sub) {
                    this.currentSubject = sub;
                    this.mobileMenuOpen = false; // Close menu on mobile selection
                    this.examType = 'dse'; // Reset to DSE when switching subjects
                    this.language = 'zh'; // Reset to Chinese
                    window.scrollTo(0, 0);
                },
                async switchExamType(exam) {
                    if (this.examType === exam || this.isSwitching) return;
                    
                    this.isSwitching = true;
                    // Brief white flash effect
                    const contentArea = document.querySelector('#app > main > div.max-w-5xl.mx-auto.mt-8');
                    if (contentArea) {
                        contentArea.style.backgroundColor = '#ffffff';
                        setTimeout(() => {
                            this.examType = exam;
                            setTimeout(() => {
                                contentArea.style.backgroundColor = '';
                                this.isSwitching = false;
                            }, 150);
                        }, 150);
                    } else {
                        this.examType = exam;
                        this.isSwitching = false;
                    }
                },
                async switchLanguage(lang) {
                    if (this.language === lang || this.isSwitching) return;
                    
                    this.isSwitching = true;
                    // Brief white flash effect
                    const contentArea = document.querySelector('#app > main > div.max-w-5xl.mx-auto.mt-8');
                    if (contentArea) {
                        contentArea.style.backgroundColor = '#ffffff';
                        setTimeout(() => {
                            this.language = lang;
                            setTimeout(() => {
                                contentArea.style.backgroundColor = '';
                                this.isSwitching = false;
                            }, 150);
                        }, 150);
                    } else {
                        this.language = lang;
                        this.isSwitching = false;
                    }
                },
                goHome() {
                    this.currentSubject = null;
                    this.mobileMenuOpen = false;
                },
                getMeta(name) {
                    // 精确匹配优先，避免误匹配
                    if (SUBJECT_META[name]) {
                        return SUBJECT_META[name];
                    }
                    
                    // 部分匹配，但需要更精确的条件
                    for (const key in SUBJECT_META) {
                        if (name === key ||
                            (name.includes(key) && (key.length >= name.length * 0.6 || name.includes(key + ' ') || name.includes(' ' + key)))) {
                            return SUBJECT_META[key];
                        }
                    }
                    return { zh: name, en: name, category: 'Others', icon: 'folder' };
                },
                mapCategoryName(cat) {
                    return CATEGORY_MAP[cat] || cat;
                },
                getYearRange(sub) {
                    if (sub.years_summary && sub.years_summary.dse) {
                        return `${sub.years_summary.dse.min}-${sub.years_summary.dse.max}`;
                    }
                    if (sub.years_summary && sub.years_summary.ce) {
                        return `${sub.years_summary.ce.min}-${sub.years_summary.ce.max}`;
                    }
                    return '1980-2025'; // Fallback
                },
                getAllFiles(sub) {
                    let files = [];
                    // V2 structure handling
                    if (sub.exams) {
                        Object.values(sub.exams).forEach(exam => {
                            Object.values(exam.years).forEach(year => {
                                Object.values(year.languages).forEach(lang => {
                                    lang.files.forEach(f => {
                                        files.push({ ...f, year: year.display });
                                    });
                                });
                            });
                        });
                    } else if (sub.files) {
                        files = sub.files;
                    }
                    return files;
                },
                getShortFileName(name) {
                    if (!name) return '';
                    // Try to make it look like the pill button "p1"
                    
                    const n = name.toLowerCase();
                    
                    // HYC Mock paper handling (e.g., "学友社 2022 Mock P1.pdf")
                    if (n.includes('mock ms1')) return 'ans1';
                    if (n.includes('mock ms2')) return 'ans2';
                    if (n.includes('mock ms')) return 'ans';
                    if (n.includes('mock p1')) return 'p1';
                    if (n.includes('mock p2')) return 'p2';
                    if (n.includes('mock p3')) return 'p3';
                    
                    if (n.includes("paper 1")) return "p1";
                    if (n.includes("paper 2")) return "p2";
                    if (n.includes("paper 3")) return "p3";
                    
                    // Remove common prefixes
                    const parts = name.split('_');
                    let cleanName = parts[parts.length - 1];
                    
                    // Remove extension
                    if (cleanName.toLowerCase().endsWith('.pdf')) {
                        cleanName = cleanName.substring(0, cleanName.length - 4);
                    }
                    return cleanName;
                },
                formatYearLabel(year) {
                    // Abbreviate long labels: Sample Paper -> SP, Practice Paper -> PP
                    if (year && year.toLowerCase().includes('sample')) {
                        return 'SP';
                    }
                    if (year && year.toLowerCase().includes('practice')) {
                        return 'PP';
                    }
                    return year;
                },
                resolveFilePath(p) {
                    if (!p) return '#';
                    // 转换public/downloads路径为根目录papers路径
                    if (p.startsWith('public/downloads/')) {
                        return '/' + p.replace('public/downloads/', 'papers/');
                    }
                    return p.startsWith('/') ? p : '/' + p;
                },
                fileWeight(file) {
                    const name = (file.name || '').toLowerCase();
                    if (name.includes('p1a')) return 10;
                    if (name.includes('p1b')) return 20;
                    if (name.includes('p1')) return 30;
                    if (name.includes('p2')) return 40;
                    if (name.includes('p3')) return 50;
                    if (name.includes('p4')) return 60;
                    if (name.includes('p5')) return 70;
                    if (name.includes('ans') || file.type === 'marking') return 80;
                    if (name.includes('per') || file.type === 'report') return 90;
                    return 999;
                },
                async downloadYear(yearData) {
                    if (!window.JSZip || !window.saveAs) {
                        alert('JSZip/FileSaver 未加载，无法打包下载');
                        return;
                    }
                    this.downloadingYear = yearData.year;
                    try {
                        const zip = new JSZip();
                        for (const file of yearData.files) {
                            const url = this.resolveFilePath(file.path);
                            try {
                                const res = await fetch(url);
                                if (!res.ok) continue;
                                const blob = await res.blob();
                                zip.file(file.name, blob);
                            } catch (e) {
                                console.warn('download skip', url, e);
                            }
                        }
                        const content = await zip.generateAsync({ type: 'blob' });
                        const subjKey = (this.currentSubject && this.currentSubject.key) || 'papers';
                        saveAs(content, `${subjKey}_${yearData.year}.zip`);
                    } catch (e) {
                        alert('打包下载失败，请稍后重试');
                        console.error(e);
                    } finally {
                        this.downloadingYear = null;
                    }
                },
                toggleDarkMode() {
                    this.isDarkMode = !this.isDarkMode;
                    // Apply dark mode class to document root
                    if (this.isDarkMode) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                },
                getAvailableExams(subject) {
                    if (!subject) return ['dse', 'ce', 'al'];

                    const available = [];
                    // 动态获取所有考试类型，而不是硬编码
                    const allExams = subject.exams ? Object.keys(subject.exams) : ['dse', 'ce', 'al'];

                    // Check based on exams structure (V2)
                    if (subject.exams) {
                        allExams.forEach(exam => {
                            if (subject.exams[exam] && subject.exams[exam].years) {
                                // Check if this exam type has any files
                                const hasFiles = Object.values(subject.exams[exam].years).some(yearData => {
                                    if (yearData.languages) {
                                        return Object.values(yearData.languages).some(langData => {
                                            return langData.files && langData.files.length > 0;
                                        });
                                    }
                                    return false;
                                });
                                if (hasFiles) available.push(exam);
                            }
                        });
                    }
                    // Fallback: Check flat files structure (V1)
                    else if (subject.files) {
                        allExams.forEach(exam => {
                            const hasFiles = subject.files.some(f => {
                                const path = (f.path || '').toLowerCase();
                                return path.includes(`/${exam}/`);
                            });
                            if (hasFiles) available.push(exam);
                        });
                    }
                    
                    // If no exams found or all exams filtered out, default to all
                    return available.length > 0 ? available : ['dse', 'ce', 'al'];
                },
                getAvailableLanguages(subject) {
                    if (!subject) return ['zh', 'en'];
                    
                    const available = [];
                    const allLangs = ['chi', 'eng']; // File path languages
                    
                    // Check based on exams structure (V2)
                    if (subject.exams) {
                        const examData = subject.exams[this.examType];
                        if (examData && examData.years) {
                            allLangs.forEach(lang => {
                                const hasFiles = Object.values(examData.years).some(yearData => {
                                    if (yearData.languages && yearData.languages[lang]) {
                                        return yearData.languages[lang].files && yearData.languages[lang].files.length > 0;
                                    }
                                    return false;
                                });
                                if (hasFiles) available.push(lang);
                            });
                        }
                    }
                    // Fallback: Check flat files structure (V1)
                    else if (subject.files) {
                        allLangs.forEach(lang => {
                            const hasFiles = subject.files.some(f => {
                                const path = (f.path || '').toLowerCase();
                                return path.includes(`/${lang}/`);
                            });
                            if (hasFiles) available.push(lang);
                        });
                    }
                    
                    // If no languages found or all filtered out, default to both
                    return available.length > 0 ? available : ['chi', 'eng'];
                },
                registerServiceWorker() {
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('/sw.js')
                            .then(function(registration) {
                                console.log('ServiceWorker registration successful');
                            })
                            .catch(function(err) {
                                console.log('ServiceWorker registration failed');
                            });
                    }
                }
            },
            mounted() {
                this.loadData();
                this.registerServiceWorker();
            }
        }).mount('#app');
    </script>
</body>

</html>
