<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE Library - 下載管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .log-container { font-family: 'Consolas', 'Monaco', monospace; }
        .log-info { color: #3b82f6; }
        .log-warn { color: #f59e0b; }
        .log-error { color: #ef4444; }
        .log-success { color: #10b981; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- 标题 -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-blue-400 mb-2">
                <i class="fas fa-download mr-2"></i>DSE Library 管理面板
            </h1>
            <p class="text-gray-400">监控下载进度、查看状态、管理资源</p>
        </header>

        <!-- 脚本控制面板 -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-8">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-terminal mr-2"></i>脚本控制
            </h2>
            
            <!-- 后端状态 -->
            <div id="backendStatus" class="mb-4 p-3 rounded bg-yellow-900/30 border border-yellow-700">
                <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                <span class="text-yellow-400">后端服务未连接</span>
                <span class="text-gray-400 text-sm ml-2">运行 python admin_server.py 启动</span>
            </div>
            
            <!-- 爬虫控制 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-900 rounded-lg p-4">
                    <h3 class="font-medium mb-3"><i class="fas fa-spider mr-2 text-blue-400"></i>爬虫控制</h3>
                    
                    <!-- 科目选择 -->
                    <div class="mb-3">
                        <label class="text-sm text-gray-400 block mb-2">选择科目（留空爬取全部）:</label>
                        <div id="subjectCheckboxes" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
                            <span class="text-gray-500 text-sm">加载中...</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="startScraper()" id="btnStartScraper" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition disabled:opacity-50">
                            <i class="fas fa-play mr-2"></i>启动爬虫
                        </button>
                        <button onclick="stopProcess('scraper')" id="btnStopScraper" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition disabled:opacity-50" disabled>
                            <i class="fas fa-stop"></i>
                        </button>
                    </div>
                    <div id="scraperStatus" class="text-sm text-gray-400 mt-2"></div>
                </div>
                
                <div class="bg-gray-900 rounded-lg p-4">
                    <h3 class="font-medium mb-3"><i class="fas fa-database mr-2 text-purple-400"></i>索引器控制</h3>
                    <p class="text-sm text-gray-400 mb-3">扫描下载目录，生成前端索引文件</p>
                    
                    <div class="flex gap-2">
                        <button onclick="startIndexer()" id="btnStartIndexer" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition disabled:opacity-50">
                            <i class="fas fa-sync-alt mr-2"></i>运行索引器
                        </button>
                        <button onclick="stopProcess('indexer')" id="btnStopIndexer" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition disabled:opacity-50" disabled>
                            <i class="fas fa-stop"></i>
                        </button>
                    </div>
                    <div id="indexerStatus" class="text-sm text-gray-400 mt-2"></div>
                </div>
            </div>
        </div>

        <!-- 状态卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">已访问页面</div>
                <div class="text-base leading-tight font-semibold text-blue-300 break-words" id="visitedCount">0</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">已下载文件</div>
                <div class="text-2xl font-bold text-green-400" id="downloadedCount">0</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">失败数量</div>
                <div class="text-2xl font-bold text-red-400" id="failedCount">0</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">外部链接</div>
                <div class="text-2xl font-bold text-yellow-400" id="externalCount">0</div>
            </div>
        </div>

        <!-- 进度条 -->
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 mb-8">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2 text-sm text-gray-300">
                    <i class="fas fa-chart-line text-green-400"></i>
                    <span>总体进度</span>
                </div>
                <div class="text-sm text-gray-400" id="overallLabel">-</div>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                <div id="overallBar" class="h-full bg-green-500 transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="text-xs text-gray-400 mt-2" id="overallDetail">等待开始...</div>
        </div>

        <!-- 控制面板 -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-8">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-cog mr-2"></i>控制面板
            </h2>
            <div class="flex flex-wrap gap-4">
                <button onclick="refreshState()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">
                    <i class="fas fa-sync-alt mr-2"></i>刷新状态
                </button>
                <button onclick="toggleAutoRefresh()" id="autoRefreshBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition">
                    <i class="fas fa-play mr-2"></i>自动刷新: 关
                </button>
                <button onclick="clearState()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
                    <i class="fas fa-trash mr-2"></i>清除状态
                </button>
            </div>
            <div class="mt-4 text-sm text-gray-400">
                上次更新: <span id="lastUpdate">-</span>
            </div>
        </div>

        <!-- 标签页 -->
        <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
            <div class="flex border-b border-gray-700">
                <button onclick="showTab('log')" id="tabLog" class="px-6 py-3 bg-gray-700 text-white font-medium">
                    <i class="fas fa-terminal mr-2"></i>日志
                </button>
                <button onclick="showTab('files')" id="tabFiles" class="px-6 py-3 text-gray-400 hover:bg-gray-700 transition">
                    <i class="fas fa-file mr-2"></i>已下载
                </button>
                <button onclick="showTab('failed')" id="tabFailed" class="px-6 py-3 text-gray-400 hover:bg-gray-700 transition">
                    <i class="fas fa-exclamation-triangle mr-2"></i>失败
                </button>
                <button onclick="showTab('external')" id="tabExternal" class="px-6 py-3 text-gray-400 hover:bg-gray-700 transition">
                    <i class="fas fa-external-link-alt mr-2"></i>外部链接
                </button>
            </div>

            <!-- 日志面板 -->
            <div id="panelLog" class="p-4">
                <div class="log-container bg-gray-900 rounded p-4 h-96 overflow-y-auto text-sm" id="logContent">
                    <div class="text-gray-500">等待日志...</div>
                </div>
            </div>

            <!-- 已下载文件面板 -->
            <div id="panelFiles" class="p-4 hidden">
                <div class="mb-4">
                    <input type="text" id="fileSearch" placeholder="搜索文件..." 
                           class="w-full px-4 py-2 bg-gray-900 border border-gray-600 rounded-lg focus:border-blue-500 outline-none">
                </div>
                <div class="h-96 overflow-y-auto" id="filesList">
                    <div class="text-gray-500 text-center py-8">暂无下载记录</div>
                </div>
            </div>

            <!-- 失败面板 -->
            <div id="panelFailed" class="p-4 hidden">
                <div class="h-96 overflow-y-auto" id="failedList">
                    <div class="text-gray-500 text-center py-8">暂无失败记录</div>
                </div>
            </div>

            <!-- 外部链接面板 -->
            <div id="panelExternal" class="p-4 hidden">
                <div class="h-96 overflow-y-auto" id="externalList">
                    <div class="text-gray-500 text-center py-8">暂无外部链接</div>
                </div>
            </div>
        </div>

        <!-- 索引验证 -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mt-8">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-check-circle mr-2"></i>索引验证
            </h2>
            <div class="flex flex-wrap gap-4 mb-4">
                <button onclick="loadIndexData()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition">
                    <i class="fas fa-database mr-2"></i>加载索引数据
                </button>
            </div>
            <div id="indexInfo" class="bg-gray-900 rounded p-4 text-sm">
                <div class="text-gray-500">点击"加载索引数据"查看索引状态</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8088';
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        let backendConnected = false;

        // ============ 后端 API 调用 ============
        
        async function checkBackend() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                if (response.ok) {
                    backendConnected = true;
                    const data = await response.json();
                    updateBackendStatus(true, data);
                    loadSubjects();
                    return data;
                }
            } catch (e) {
                backendConnected = false;
                updateBackendStatus(false);
            }
            return null;
        }
        
        function updateBackendStatus(connected, data = null) {
            const el = document.getElementById('backendStatus');
            if (connected) {
                let processInfo = '';
                if (data && data.processes) {
                    const running = Object.entries(data.processes)
                        .filter(([k, v]) => v === 'running')
                        .map(([k]) => k);
                    if (running.length > 0) {
                        processInfo = ` | 运行中: ${running.join(', ')}`;
                    }
                }
                el.className = 'mb-4 p-3 rounded bg-green-900/30 border border-green-700';
                el.innerHTML = `
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    <span class="text-green-400">后端服务已连接</span>
                    <span class="text-gray-400 text-sm ml-2">${API_BASE}${processInfo}</span>
                `;
                
                // 更新按钮状态
                updateProcessButtons(data?.processes || {});
            } else {
                el.className = 'mb-4 p-3 rounded bg-yellow-900/30 border border-yellow-700';
                el.innerHTML = `
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                    <span class="text-yellow-400">后端服务未连接</span>
                    <span class="text-gray-400 text-sm ml-2">运行 python admin_server.py 启动</span>
                `;
            }
        }
        
        function updateProcessButtons(processes) {
            const scraperRunning = processes.scraper === 'running';
            const indexerRunning = processes.indexer === 'running';
            
            document.getElementById('btnStartScraper').disabled = scraperRunning;
            document.getElementById('btnStopScraper').disabled = !scraperRunning;
            document.getElementById('btnStartIndexer').disabled = indexerRunning;
            document.getElementById('btnStopIndexer').disabled = !indexerRunning;
            
            document.getElementById('scraperStatus').textContent = scraperRunning ? '爬虫运行中...' : '';
            document.getElementById('indexerStatus').textContent = indexerRunning ? '索引器运行中...' : '';
        }

        function updateProgressBar(summary) {
            const overall = summary.overall || {};
            const subjects = summary.subjects || [];
            const percent = overall.percent ?? 0;
            document.getElementById('overallBar').style.width = `${percent}%`;
            document.getElementById('overallLabel').textContent = `${percent || 0}%`;
            document.getElementById('overallDetail').textContent = `已完成 ${overall.subjects_done || 0}/${overall.subjects_total || subjects.length} 科目 | 下载 ${overall.downloaded || 0}/${overall.total_urls || '?'} | 发现 ${overall.found || 0}`;
        }
        
        async function loadSubjects() {
            try {
                const response = await fetch(`${API_BASE}/api/subjects`);
                const data = await response.json();
                const container = document.getElementById('subjectCheckboxes');
                
                container.innerHTML = Object.entries(data.subjects).map(([key, info]) => `
                    <label class="flex items-center gap-1 px-2 py-1 bg-gray-800 rounded cursor-pointer hover:bg-gray-700">
                        <input type="checkbox" value="${key}" class="subject-checkbox">
                        <span class="text-xs">${info.name_zh}</span>
                    </label>
                `).join('');
            } catch (e) {
                document.getElementById('subjectCheckboxes').innerHTML = 
                    '<span class="text-red-400 text-sm">加载失败</span>';
            }
        }
        
        async function startScraper() {
            const checkboxes = document.querySelectorAll('.subject-checkbox:checked');
            const subjects = Array.from(checkboxes).map(cb => cb.value);
            
            try {
                const response = await fetch(`${API_BASE}/api/scraper/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subjects })
                });
                const data = await response.json();
                
                if (response.ok) {
                    addLog(data.message, 'success');
                    checkBackend();
                } else {
                    addLog(data.message, 'error');
                }
            } catch (e) {
                addLog('启动爬虫失败: ' + e.message, 'error');
            }
        }
        
        async function startIndexer() {
            try {
                const response = await fetch(`${API_BASE}/api/indexer/start`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    addLog(data.message, 'success');
                    checkBackend();
                } else {
                    addLog(data.message, 'error');
                }
            } catch (e) {
                addLog('启动索引器失败: ' + e.message, 'error');
            }
        }
        
        async function stopProcess(name) {
            try {
                const response = await fetch(`${API_BASE}/api/process/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                const data = await response.json();
                addLog(data.message, response.ok ? 'success' : 'error');
                checkBackend();
            } catch (e) {
                addLog('停止失败: ' + e.message, 'error');
            }
        }
        
        async function fetchLog() {
            try {
                const response = await fetch(`${API_BASE}/api/log?lines=100`);
                const data = await response.json();
                if (data.log) {
                    updateLogContent(data.log);
                }
            } catch (e) {
                // 后端未连接时静默失败
            }
        }

        // 刷新状态
        async function refreshState() {
            // 优先从后端API获取状态
            if (backendConnected) {
                try {
                    const response = await fetch(`${API_BASE}/api/status`);
                    if (response.ok) {
                        const data = await response.json();
                        const state = data.state || {};
                        
                        document.getElementById('downloadedCount').textContent = state.downloaded_files || 0;
                        document.getElementById('failedCount').textContent = state.failed_urls || 0;
                        document.getElementById('lastUpdate').textContent = state.last_update || '-';
                        
                        // 显示进度信息
                        if (state.summary) {
                            updateProgressBar(state.summary);
                            const overall = state.summary.overall || {};
                            document.getElementById('visitedCount').textContent =
                                `下载 ${overall.downloaded || 0}/${overall.total_urls || '?'} | 科目 ${overall.subjects_done || 0}/${overall.subjects_total || 0}`;
                        } else if (state.progress) {
                            const progressText = Object.entries(state.progress)
                                .map(([subj, info]) => `${subj}: ${info.downloaded || 0}/${info.total_urls || '?'} (${info.completed ? '完成' : '进行中'})`)
                                .join(' | ');
                            document.getElementById('visitedCount').textContent = progressText || '0';
                        }
                        
                        // 更新文件列表
                        if (data.files) {
                            updateFilesList(data.files.downloaded || []);
                            updateFailedList(data.files.failed || {});
                        }
                        
                        // 更新按钮状态
                        updateProcessButtons(data.processes || {});
                    }
                } catch (e) {
                    console.warn('后端状态获取失败:', e);
                }
                
                // 获取日志
                await fetchLog();
            } else {
                // 后端未连接时尝试直接读取文件（仅在生产环境有效）
                try {
                    const response = await fetch('scraper_state.json');
                    if (!response.ok) throw new Error('状态文件不存在');
                    const state = await response.json();
                    
                    document.getElementById('downloadedCount').textContent = state.downloaded_files?.length || 0;
                    document.getElementById('failedCount').textContent = Object.keys(state.failed_urls || {}).length;
                    document.getElementById('lastUpdate').textContent = state.last_update || new Date().toLocaleString();
                    
                    updateFilesList(state.downloaded_files || []);
                    updateFailedList(state.failed_urls || {});
                } catch (e) {
                    console.warn('本地状态获取失败:', e);
                }
            }
        }

        // 更新日志内容
        function updateLogContent(logText) {
            const container = document.getElementById('logContent');
            const lines = logText.split('\n').filter(l => l.trim()).slice(-100); // 只显示最后100行
            
            container.innerHTML = lines.map(line => {
                let cssClass = '';
                if (line.includes('[ERROR]')) cssClass = 'log-error';
                else if (line.includes('[WARN]')) cssClass = 'log-warn';
                else if (line.includes('[INFO]') && (line.includes('成功') || line.includes('完成'))) cssClass = 'log-success';
                else cssClass = 'log-info';
                
                return `<div class="${cssClass}">${escapeHtml(line)}</div>`;
            }).join('') || '<div class="text-gray-500">暂无日志</div>';
            
            container.scrollTop = container.scrollHeight;
        }

        // 添加日志
        function addLog(message, type = 'info') {
            const container = document.getElementById('logContent');
            const time = new Date().toLocaleTimeString();
            const cssClass = {
                'info': 'log-info',
                'warn': 'log-warn',
                'error': 'log-error',
                'success': 'log-success'
            }[type] || 'log-info';
            
            const div = document.createElement('div');
            div.className = cssClass;
            div.textContent = `[${time}] ${message}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // 更新文件列表
        function updateFilesList(files) {
            const container = document.getElementById('filesList');
            if (files.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-8">暂无下载记录</div>';
                return;
            }
            
            container.innerHTML = files.slice().reverse().map((url, index) => {
                // 从PDF URL中提取信息
                const parts = url.split('/');
                const filename = parts[parts.length - 1];
                const year = parts[parts.length - 2];
                const lang = parts[parts.length - 3];
                const exam = parts[parts.length - 4];
                const subject = parts[parts.length - 5];
                
                return `
                <div class="py-2 px-3 border-b border-gray-700 hover:bg-gray-700 rounded transition">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm text-blue-400 font-medium truncate">${escapeHtml(filename)}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                <span class="inline-block px-2 py-0.5 bg-gray-800 rounded mr-1">${subject}</span>
                                <span class="inline-block px-2 py-0.5 bg-gray-800 rounded mr-1">${exam.toUpperCase()}</span>
                                <span class="inline-block px-2 py-0.5 bg-gray-800 rounded mr-1">${lang === 'chi' ? '中文' : '英文'}</span>
                                <span class="inline-block px-2 py-0.5 bg-gray-800 rounded">${year}</span>
                            </div>
                        </div>
                        <div class="text-xs text-gray-600 ml-2">#${files.length - index}</div>
                    </div>
                </div>
            `;
            }).join('');
        }

        // 更新失败列表
        function updateFailedList(failed) {
            const container = document.getElementById('failedList');
            const entries = Object.entries(failed);
            
            if (entries.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-8">暂无失败记录</div>';
                return;
            }
            
            container.innerHTML = entries.map(([url, error]) => `
                <div class="py-2 px-3 border-b border-gray-700">
                    <div class="text-sm text-red-400 truncate">${escapeHtml(url)}</div>
                    <div class="text-xs text-gray-500">${escapeHtml(error)}</div>
                </div>
            `).join('');
        }

        // 更新外部链接列表
        function updateExternalList(links) {
            const container = document.getElementById('externalList');
            
            if (links.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-8">暂无外部链接</div>';
                return;
            }
            
            container.innerHTML = links.map(link => `
                <div class="py-2 px-3 border-b border-gray-700">
                    <div class="text-sm text-yellow-400">${escapeHtml(link.text || '未命名')}</div>
                    <a href="${escapeHtml(link.url)}" target="_blank" class="text-xs text-blue-400 hover:underline truncate block">
                        ${escapeHtml(link.url)}
                    </a>
                    <div class="text-xs text-gray-500">分类: ${escapeHtml(link.category || '未知')}</div>
                </div>
            `).join('');
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            isAutoRefresh = !isAutoRefresh;
            const btn = document.getElementById('autoRefreshBtn');
            
            if (isAutoRefresh) {
                autoRefreshInterval = setInterval(() => {
                    refreshState();
                    checkBackend();
                }, 2000);  // 2秒刷新一次
                btn.innerHTML = '<i class="fas fa-pause mr-2"></i>自动刷新: 开';
                btn.classList.remove('bg-gray-600');
                btn.classList.add('bg-green-600');
                addLog('自动刷新已开启 (2秒/次)', 'success');
            } else {
                clearInterval(autoRefreshInterval);
                btn.innerHTML = '<i class="fas fa-play mr-2"></i>自动刷新: 关';
                btn.classList.remove('bg-green-600');
                btn.classList.add('bg-gray-600');
                addLog('自动刷新已关闭', 'info');
            }
        }

        // 清除状态
        function clearState() {
            if (confirm('确定要清除所有状态吗？这不会删除已下载的文件。')) {
                addLog('请手动删除 scraper_state.json 文件', 'warn');
            }
        }

        // 切换标签
        function showTab(tab) {
            const tabs = ['Log', 'Files', 'Failed', 'External'];
            tabs.forEach(t => {
                const tabBtn = document.getElementById('tab' + t);
                const panel = document.getElementById('panel' + t);
                
                if (t.toLowerCase() === tab) {
                    tabBtn.classList.add('bg-gray-700', 'text-white');
                    tabBtn.classList.remove('text-gray-400');
                    panel.classList.remove('hidden');
                } else {
                    tabBtn.classList.remove('bg-gray-700', 'text-white');
                    tabBtn.classList.add('text-gray-400');
                    panel.classList.add('hidden');
                }
            });
        }

        // 加载索引数据
        async function loadIndexData() {
            const container = document.getElementById('indexInfo');
            container.innerHTML = '<div class="text-blue-400"><i class="fas fa-spinner fa-spin mr-2"></i>加载中...</div>';
            
            try {
                const paths = [
                    '/frontend/public/data/index.json',
                    'frontend/public/data/index.json',
                    './frontend/public/data/index.json',
                    './public/data/index.json'
                ];
                let data = null;
                let lastErr = null;
                for (const p of paths) {
                    try {
                        const res = await fetch(p);
                        if (!res.ok) {
                            lastErr = new Error(`HTTP ${res.status} @ ${p}`);
                            continue;
                        }
                        data = await res.json();
                        break;
                    } catch (e) {
                        lastErr = e;
                    }
                }
                if (!data) throw lastErr || new Error('索引文件不存在');
                
                let html = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-gray-400 text-xs">总科目</div>
                            <div class="text-xl font-bold text-blue-400">${data.subjects?.length || 0}</div>
                        </div>
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-gray-400 text-xs">总文件</div>
                            <div class="text-xl font-bold text-green-400">${data.stats?.total_files || 0}</div>
                        </div>
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-gray-400 text-xs">总大小</div>
                            <div class="text-xl font-bold text-yellow-400">${formatSize(data.stats?.total_size || 0)}</div>
                        </div>
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-gray-400 text-xs">更新时间</div>
                            <div class="text-sm font-bold text-gray-300">${data.stats?.last_updated?.split('T')[0] || '-'}</div>
                        </div>
                    </div>
                    <div class="text-gray-400 text-sm mb-2">科目列表:</div>
                    <div class="flex flex-wrap gap-2">
                        ${(data.subjects || []).map(s => `
                            <span class="px-2 py-1 bg-gray-700 rounded text-xs">
                                ${escapeHtml(s.name)} (${s.file_count || 0})
                            </span>
                        `).join('')}
                    </div>
                `;
                
                container.innerHTML = html;
                addLog('索引数据加载成功', 'success');
            } catch (e) {
                container.innerHTML = `<div class="text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>${e.message}</div>`;
                addLog('加载索引失败: ' + e.message, 'error');
            }
        }

        // 工具函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 页面加载时初始化
        checkBackend();
        refreshState();
        
        // 定期检查后端状态
        setInterval(checkBackend, 5000);
    </script>
</body>
</html>
